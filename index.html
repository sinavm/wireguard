<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureVPN WireGuard Config</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; background: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; }
        button { 
            margin: 10px; 
            padding: 15px 25px; 
            font-size: 18px; 
            width: 80%; 
            border: none; 
            border-radius: 8px; 
            background: #007bff; 
            color: white; 
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .loading { display: none; color: green; font-weight: bold; }
        .error { display: none; color: red; font-weight: bold; }
        .config { margin-top: 20px; }
        pre { background: #eee; padding: 15px; text-align: left; border-radius: 8px; display: inline-block; word-break: break-all; }
        .copy-btn { margin-top: 10px; padding: 8px 16px; font-size: 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .copy-btn:hover { background: #218838; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WireGuard Config Generator</h1>
        <p>Ú©Ù„ÛŒÚ© Ú©Ù† â†’ Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ú¯ÛŒØ± (ØªÙˆÚ©Ù† Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†)</p>

        <button onclick="generate('UAE - Dubai')">ğŸ‡¦ğŸ‡ª UAE - Dubai</button>
        <button onclick="generate('UK - London')">ğŸ‡¬ğŸ‡§ UK - London</button>
        <button onclick="generate('Germany - Frankfurt')">ğŸ‡©ğŸ‡ª Germany - Frankfurt</button>
        <button onclick="generate('Netherlands - Amsterdam')">ğŸ‡³ğŸ‡± Netherlands - Amsterdam</button>
        <button onclick="generate('Turkey - Istanbul')">ğŸ‡¹ğŸ‡· Turkey - Istanbul</button>

        <div id="loading" class="loading">Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ú©Ø§Ù†ÙÛŒÚ¯... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ (Ø­Ø¯ÙˆØ¯ Û³Û°-Û¶Û° Ø«Ø§Ù†ÛŒÙ‡)</div>
        <div id="error" class="error"></div>
        <div id="result" class="config" style="display:none;">
            <pre id="config-text"></pre>
            <br>
            <button class="copy-btn" onclick="copyConfig()">Ú©Ù¾ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯</button>
        </div>
    </div>

    <script>
        let globalToken = '';

        async function generate(location) {
            globalToken = prompt('Enter your GitHub Personal Access Token (ghp_...):');
            if (!globalToken) {
                alert('ØªÙˆÚ©Ù† ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡! Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('result').style.display = 'none';

            const owner = 'sinavm';
            const repo = 'wireguard';
            const workflowFile = 'generate-config.yml';  // Ù†Ø§Ù… ÙØ§ÛŒÙ„ workflow

            try {
                // Trigger workflow
                const dispatchRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflowFile}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${globalToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ref: 'main',
                        inputs: { location: location }
                    })
                });

                if (!dispatchRes.ok) {
                    const errData = await dispatchRes.json();
                    throw new Error(`Workflow trigger failed: ${dispatchRes.status} - ${errData.message || 'Unknown error'}`);
                }

                // Poll for completion
                const run = await pollLatestRun(owner, repo, globalToken);
                if (!run) throw new Error('Workflow timed out (over 2 minutes). Check Actions tab manually.');

                if (run.conclusion !== 'success') throw new Error(`Workflow failed: ${run.conclusion}. Check Actions tab.`);

                // Get logs
                const logs = await fetchLogs(run.logs_url, globalToken);
                const config = extractConfigFromLogs(logs);

                if (!config) throw new Error('Config not found in logs. Check Actions tab.');

                document.getElementById('config-text').textContent = config;
                document.getElementById('result').style.display = 'block';
            } catch (err) {
                document.getElementById('error').textContent = 'Ø®Ø·Ø§: ' + err.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function pollLatestRun(owner, repo, token) {
            for (let i = 0; i < 40; i++) {  // 2 minutes max
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs?per_page=1`, {
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                const data = await res.json();
                const latestRun = data.workflow_runs?.[0];
                if (latestRun && latestRun.status === 'completed') {
                    return latestRun;
                }
                await new Promise(r => setTimeout(r, 3000));  // 3 sec poll
            }
            return null;
        }

        async function fetchLogs(logsUrl, token) {
            const res = await fetch(logsUrl, { 
                headers: { 
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                } 
            });
            const data = await res.json();
            if (!data.log_url) throw new Error('No log URL found');
            const logRes = await fetch(data.log_url);
            return await logRes.text();
        }

        function extractConfigFromLogs(logs) {
            const start = logs.indexOf('=== WireGuard Config ===');
            const end = logs.indexOf('=== End of Config ===');
            if (start === -1 || end === -1) return null;
            return logs.substring(start + 23, end).trim();
        }

        function copyConfig() {
            const text = document.getElementById('config-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Ú©Ø§Ù†ÙÛŒÚ¯ Ú©Ù¾ÛŒ Ø´Ø¯! (Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø¹ØªØ¨Ø±Ù‡)');
            }).catch(() => {
                alert('Ú©Ù¾ÛŒ Ù†Ø´Ø¯. Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.');
            });
        }
    </script>
</body>
</html>
