<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureVPN WireGuard Config</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; background: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; }
        button { 
            margin: 10px; 
            padding: 15px 25px; 
            font-size: 18px; 
            width: 80%; 
            border: none; 
            border-radius: 8px; 
            background: #007bff; 
            color: white; 
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .loading { display: none; color: green; font-weight: bold; }
        .error { display: none; color: red; font-weight: bold; }
        .config { margin-top: 20px; }
        pre { background: #eee; padding: 15px; text-align: left; border-radius: 8px; display: inline-block; word-break: break-all; }
        .copy-btn { margin-top: 10px; padding: 8px 16px; font-size: 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .copy-btn:hover { background: #218838; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WireGuard Config Generator</h1>
        <p>Ú©Ù„ÛŒÚ© Ú©Ù† â†’ Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ú¯ÛŒØ±</p>

        <button onclick="generate('UAE - Dubai')">ğŸ‡¦ğŸ‡ª UAE - Dubai</button>
        <button onclick="generate('UK - London')">ğŸ‡¬ğŸ‡§ UK - London</button>
        <button onclick="generate('Germany - Frankfurt')">ğŸ‡©ğŸ‡ª Germany - Frankfurt</button>
        <button onclick="generate('Netherlands - Amsterdam')">ğŸ‡³ğŸ‡± Netherlands - Amsterdam</button>
        <button onclick="generate('Turkey - Istanbul')">ğŸ‡¹ğŸ‡· Turkey - Istanbul</button>

        <div id="loading" class="loading">Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ú©Ø§Ù†ÙÛŒÚ¯... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ (Ø­Ø¯ÙˆØ¯ Û³Û°-Û¶Û° Ø«Ø§Ù†ÛŒÙ‡)</div>
        <div id="error" class="error"></div>
        <div id="result" class="config" style="display:none;">
            <pre id="config-text"></pre>
            <br>
            <button class="copy-btn" onclick="copyConfig()">Ú©Ù¾ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯</button>
        </div>
    </div>

    <script>
        // Ø¨Ø¯ÙˆÙ† token - public polling (ÙØ±Ø¶: Ø±ÛŒÙ¾Ùˆ public)

        async function generate(location) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('result').style.display = 'none';

            const owner = 'sinavm';
            const repo = 'wireguard';
            const workflowFile = 'generate-config.yml';

            try {
                // Trigger workflow Ø¨Ø¯ÙˆÙ† auth (public repo dispatch Ù…Ù…Ú©Ù†Ù‡ Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ø§Ø´Ù‡Ø› Ø§Ú¯Ù‡ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ manual trigger Ø§Ø² UI Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡)
                // Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ public repoØŒ dispatch Ø¨Ø¯ÙˆÙ† token Ù…Ù…Ú©Ù†Ù‡ fail Ø¨Ø´Ù‡ - Ø§Ú¯Ù‡ Ø´Ø¯ØŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ùˆ Ø¨Ù‡ Actions tab Ù‡Ø¯Ø§ÛŒØª Ú©Ù†
                const dispatchRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflowFile}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ref: 'main',
                        inputs: { location: location }
                    })
                });

                if (!dispatchRes.ok) {
                    // Ø§Ú¯Ù‡ 401/403/404ØŒ manual Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡
                    if (dispatchRes.status >= 400 && dispatchRes.status < 500) {
                        throw new Error(`Trigger failed (Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø±ÛŒÙ¾Ùˆ private ÛŒØ§ auth Ù„Ø§Ø²Ù…). Ø¨Ø±Ùˆ Ø¨Ù‡ GitHub > Actions tab Ùˆ Ø¯Ø³ØªÛŒ location Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ùˆ run Ú©Ù†. Ø¨Ø¹Ø¯ refresh Ú©Ù†.`);
                    }
                    const errData = await dispatchRes.json();
                    throw new Error(`Workflow trigger failed: ${dispatchRes.status} - ${errData.message || 'Unknown error'}`);
                }

                // Short delay
                await new Promise(r => setTimeout(r, 5000));

                // Poll public runs (Ø¨Ø¯ÙˆÙ† token)
                const run = await pollLatestRun(owner, repo);
                if (!run) throw new Error('Workflow timed out (over 2 minutes). Check Actions tab manually.');

                if (run.conclusion !== 'success') throw new Error(`Workflow failed: ${run.conclusion}. Check Actions tab.`);

                // Fetch public logs (Ø¨Ø¯ÙˆÙ† token - Ø¨Ø±Ø§ÛŒ public repo)
                const logs = await fetchLogs(run.id);
                const config = extractConfigFromLogs(logs);

                if (!config) throw new Error('Config not found in logs. Check Actions tab.');

                document.getElementById('config-text').textContent = config;
                document.getElementById('result').style.display = 'block';
            } catch (err) {
                document.getElementById('error').textContent = 'Ø®Ø·Ø§: ' + err.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function pollLatestRun(owner, repo) {
            for (let i = 0; i < 40; i++) {  // 2 min max
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs?per_page=1`);
                if (!res.ok) throw new Error('Failed to poll runs (repo public? check internet)');
                const data = await res.json();
                const latestRun = data.workflow_runs?.[0];
                if (latestRun && latestRun.status === 'completed') {
                    return latestRun;
                }
                await new Promise(r => setTimeout(r, 3000));
            }
            return null;
        }

        async function fetchLogs(runId) {
            // Public logs URL (redirect to raw text)
            const logsUrl = `https://api.github.com/repos/sinavm/wireguard/actions/runs/${runId}/logs`;
            const res = await fetch(logsUrl);
            if (!res.ok) throw new Error(`Failed to fetch logs: ${res.status} (repo public?)`);
            // Follow redirect for raw text
            const textRes = await fetch(res.url.replace('/api.', '/'), { redirect: 'follow' });
            return await textRes.text();
        }

        function extractConfigFromLogs(logs) {
            const start = logs.indexOf('=== WireGuard Config ===');
            const end = logs.indexOf('=== End of Config ===', start);
            if (start === -1 || end === -1) return null;
            return logs.substring(start + 23, end).trim();
        }

        function copyConfig() {
            const text = document.getElementById('config-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Ú©Ø§Ù†ÙÛŒÚ¯ Ú©Ù¾ÛŒ Ø´Ø¯! (Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø¹ØªØ¨Ø±Ù‡)');
            }).catch(() => {
                alert('Ú©Ù¾ÛŒ Ù†Ø´Ø¯. Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.');
            });
        }
    </script>
</body>
</html>
