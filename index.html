<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureVPN WireGuard Config</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;text-align:center;margin-top:40px}
        .c{max-width:600px;margin:auto}
        button{margin:8px;padding:14px 20px;font-size:17px;width:78%;border:none;border-radius:6px;background:#007bff;color:#fff;cursor:pointer}
        button:hover{background:#0056b3}
        .loading,.error{display:none;color:green;font-weight:bold}
        .error{color:red}
        pre{background:#eee;padding:14px;border-radius:6px;white-space:pre-wrap;word-break:break-all}
        .copy-btn{margin-top:8px;padding:6px 12px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer}
        .copy-btn:hover{background:#218838}
    </style>
</head>
<body>
<div class="c">
    <h1>WireGuard Config Generator</h1>
    <p>کلیک → ۳۰ دقیقه کانفیگ</p>

    <button onclick="gen('UAE - Dubai')">UAE - Dubai</button>
    <button onclick="gen('UK - London')">UK - London</button>
    <button onclick="gen('Germany - Frankfurt')">Germany - Frankfurt</button>
    <button onclick="gen('Netherlands - Amsterdam')">Netherlands - Amsterdam</button>
    <button onclick="gen('Turkey - Istanbul')">Turkey - Istanbul</button>

    <div id="loading" class="loading">در حال تولید… (30‑60 ثانیه)</div>
    <div id="error" class="error"></div>
    <div id="result" style="display:none;margin-top:20px">
        <pre id="cfg"></pre>
        <button class="copy-btn" onclick="copy()">کپی کانفیگ</button>
    </div>
</div>

<script>
const owner = 'sinavm', repo = 'wireguard', wf = 'generate-config.yml';

async function gen(loc) {
    $('#loading').show(); $('#error').hide(); $('#result').hide();
    try {
        // 1. trigger (public repo → dispatch بدون توکن کار می‌کند)
        const d = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/${wf}/dispatches`, {
            method:'POST',
            headers:{'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},
            body:JSON.stringify({ref:'main',inputs:{location:loc}})
        });
        if (!d.ok) {
            const e = await d.json();
            if (d.status===404) throw new Error('Workflow نه پیدا شد. فایل .github/workflows/generate-config.yml را چک کن.');
            throw new Error(e.message||'خطا در trigger');
        }

        await sleep(5000);               // زمان شروع run
        const run = await pollRun();
        if (!run) throw new Error('تایم‌اوت (2 دقیقه). در Actions تب چک کن.');

        if (run.conclusion!=='success') throw new Error(`workflow شکست: ${run.conclusion}`);

        const logs = await fetchLogs(run.id);
        const cfg = extract(logs);
        if (!cfg) throw new Error('کانفیگ در لاگ‌ها پیدا نشد.');

        $('#cfg').textContent = cfg;
        $('#result').show();
    } catch(e){
        $('#error').textContent = 'خطا: '+e.message; $('#error').show();
    } finally {$('#loading').hide();}
}

/* ---------- helpers ---------- */
function $(s){return document.querySelector(s);}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

async function pollRun(){
    for(let i=0;i<40;i++){
        const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs?per_page=1`);
        if(!r.ok) throw new Error('poll error');
        const j = await r.json();
        const run = j.workflow_runs?.[0];
        if(run && run.status==='completed') return run;
        await sleep(3000);
    }
    return null;
}
async function fetchLogs(id){
    const u = `https://api.github.com/repos/${owner}/${repo}/actions/runs/${id}/logs`;
    const r = await fetch(u);
    if(!r.ok) throw new Error('log fetch error');
    // GitHub redirects to raw txt → follow
    const txt = await fetch(r.url.replace('api.','')).then(t=>t.text());
    return txt;
}
function extract(txt){
    const s = txt.indexOf('=== WireGuard Config ===');
    const e = txt.indexOf('=== End of Config ===',s);
    return s===-1||e===-1 ? null : txt.substring(s+24,e).trim();
}
function copy(){
    navigator.clipboard.writeText($('#cfg').textContent)
      .then(()=>alert('کپی شد! (30 دقیقه معتبر)'))
      .catch(()=>alert('کپی نشد، دستی انتخاب کن'));
}
</script>
</body>
</html>
