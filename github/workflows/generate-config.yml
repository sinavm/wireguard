name: Generate WireGuard Config

on:
  workflow_dispatch:
    inputs:
      location:
        description: 'Select Location'
        required: true
        default: 'Germany-Frankfurt'
        type: choice
        options:
          - UAE-Dubai
          - UK-London
          - Germany-Frankfurt
          - Netherlands-Amsterdam
          - Turkey-Istanbul

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip xvfb
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          sudo ln -s /usr/bin/google-chrome-stable /usr/local/bin/chrome

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Determine country and city
        id: vars
        run: |
          case "${{ github.event.inputs.location }}" in
            "UAE-Dubai")
              echo "country=AE" >> $GITHUB_OUTPUT
              echo "city=1003" >> $GITHUB_OUTPUT
              ;;
            "UK-London")
              echo "country=GB" >> $GITHUB_OUTPUT
              echo "city=2001" >> $GITHUB_OUTPUT
              ;;
            "Germany-Frankfurt")
              echo "country=DE" >> $GITHUB_OUTPUT
              echo "city=2762" >> $GITHUB_OUTPUT
              ;;
            "Netherlands-Amsterdam")
              echo "country=NL" >> $GITHUB_OUTPUT
              echo "city=3002" >> $GITHUB_OUTPUT
              ;;
            "Turkey-Istanbul")
              echo "country=TR" >> $GITHUB_OUTPUT
              echo "city=4004" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Build and run
        env:
          PUREVPN_USERNAME: ${{ secrets.PUREVPN_USERNAME }}
          PUREVPN_PASSWORD: ${{ secrets.PUREVPN_PASSWORD }}
          PUREVPN_SUBSCRIPTION_USERNAME: ${{ secrets.PUREVPN_SUB_USER }}
          PUREVPN_SERVER_COUNTRY: ${{ steps.vars.outputs.country }}
          PUREVPN_SERVER_CITY: ${{ steps.vars.outputs.city }}
          PUREVPN_DEVICE: linux
          PUREVPN_WIREGUARD_FILE: /tmp/wg0.conf
        run: |
          go mod download
          go build -o wireguard ./cmd/wireguard
          xvfb-run --auto-servernum ./wireguard full
          echo "## Generated WireGuard Config" >> $GITHUB_STEP_SUMMARY
          echo '```conf' >> $GITHUB_STEP_SUMMARY
          cat /tmp/wg0.conf >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/wg0.conf

      - name: Upload config as artifact
        uses: actions/upload-artifact@v4
        with:
          name: wg-config-${{ github.event.inputs.location }}
          path: /tmp/wg0.conf
