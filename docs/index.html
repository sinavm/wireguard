<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯ WireGuard PureVPN</title>
    <style>
        body { 
            font-family: 'Tahoma', Arial, sans-serif; 
            text-align: center; 
            padding: 50px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            margin: 0;
        }
        h1 { color: #333; margin-bottom: 30px; }
        p { color: #666; margin-bottom: 40px; font-size: 16px; }
        .location-btn { 
            display: block; 
            margin: 20px auto; 
            padding: 20px 40px; 
            font-size: 20px; 
            cursor: pointer; 
            border: none; 
            border-radius: 10px; 
            background: linear-gradient(45deg, #007bff, #0056b3); 
            color: white; 
            box-shadow: 0 4px 15px rgba(0,123,255,0.3); 
            transition: all 0.3s ease; 
            width: 300px;
        }
        .location-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(0,123,255,0.4); 
        }
        .location-btn:active { 
            transform: translateY(0); 
        }
        #message { 
            display: none; 
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #28a745; 
            color: white; 
            padding: 15px 30px; 
            border-radius: 5px; 
            z-index: 1000; 
            font-size: 18px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
        }
        #loading { 
            display: none; 
            color: #007bff; 
            font-size: 16px; 
            margin-top: 20px; 
        }
        #error { 
            display: none; 
            background: #dc3545; 
            color: white; 
            padding: 15px; 
            margin: 20px; 
            border-radius: 5px; 
        }
    </style>
</head>
<body>
    <h1>Ø§Ù†ØªØ®Ø§Ø¨ Ù„ÙˆÚ©ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯ WireGuard (Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø¹ØªØ¨Ø±)</h1>
    <p>Ø±ÙˆÛŒ Ù¾Ø±Ú†Ù… Ù„ÙˆÚ©ÛŒØ´Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ù‡ Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ Ú©Ù¾ÛŒ Ø´ÙˆØ¯. GitHub Actions Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¬Ø¯ÛŒØ¯ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.</p>
    
    <button class="location-btn" onclick="generateAndCopy('UAE-Dubai', 'ğŸ‡¦ğŸ‡ª Ø§Ù…Ø§Ø±Ø§Øª - Ø¯Ø¨ÛŒ')">
        ğŸ‡¦ğŸ‡ª Ø§Ù…Ø§Ø±Ø§Øª - Ø¯Ø¨ÛŒ
    </button>
    <button class="location-btn" onclick="generateAndCopy('UK-London', 'ğŸ‡¬ğŸ‡§ Ø§Ù†Ú¯Ù„ÛŒØ³ - Ù„Ù†Ø¯Ù†')">
        ğŸ‡¬ğŸ‡§ Ø§Ù†Ú¯Ù„ÛŒØ³ - Ù„Ù†Ø¯Ù†
    </button>
    <button class="location-btn" onclick="generateAndCopy('Germany-Frankfurt', 'ğŸ‡©ğŸ‡ª Ø¢Ù„Ù…Ø§Ù† - ÙØ±Ø§Ù†Ú©ÙÙˆØ±Øª')">
        ğŸ‡©ğŸ‡ª Ø¢Ù„Ù…Ø§Ù† - ÙØ±Ø§Ù†Ú©ÙÙˆØ±Øª
    </button>
    <button class="location-btn" onclick="generateAndCopy('Netherlands-Amsterdam', 'ğŸ‡³ğŸ‡± Ù‡Ù„Ù†Ø¯ - Ø¢Ù…Ø³ØªØ±Ø¯Ø§Ù…')">
        ğŸ‡³ğŸ‡± Ù‡Ù„Ù†Ø¯ - Ø¢Ù…Ø³ØªØ±Ø¯Ø§Ù…
    </button>
    <button class="location-btn" onclick="generateAndCopy('Turkey-Istanbul', 'ğŸ‡¹ğŸ‡· ØªØ±Ú©ÛŒÙ‡ - Ø§Ø³ØªØ§Ù†Ø¨ÙˆÙ„')">
        ğŸ‡¹ğŸ‡· ØªØ±Ú©ÛŒÙ‡ - Ø§Ø³ØªØ§Ù†Ø¨ÙˆÙ„
    </button>

    <div id="loading">Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ú©Ø§Ù†ÙÛŒÚ¯... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ (ØªØ§ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡).</div>
    <div id="error"></div>
    <div id="message">Ú©Ø§Ù†ÙÛŒÚ¯ Ø´Ù…Ø§ Ú©Ù¾ÛŒ Ø´Ø¯! Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ø¯Ø± WireGuard Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</div>

    <script>
        async function generateAndCopy(locationId, locationName) {
            const token = prompt('Ù„Ø·ÙØ§Ù‹ GitHub Personal Access Token (repo scope) Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
            if (!token) {
                showError('ØªÙˆÚ©Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!');
                return;
            }

            const repo = 'sinavm/wireguard';
            const payload = {
                ref: 'gh-pages',
                inputs: { location: locationId }
            };

            showLoading(true);

            try {
                // Dispatch workflow
                const dispatchResponse = await fetch(`https://api.github.com/repos/${repo}/actions/workflows/generate-config.yml/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'X-GitHub-Api-Version': '2022-11-28',
                        'User-Agent': 'WireGuard-Generator'
                    },
                    body: JSON.stringify(payload)
                });

                if (!dispatchResponse.ok) {
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ workflow. ØªÙˆÚ©Ù† ÛŒØ§ repo Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.');
                }

                // Poll for workflow completion (every 10s, up to 5min)
                let runId = null;
                let attempts = 0;
                const maxAttempts = 30;

                while (attempts < maxAttempts) {
                    const runsResponse = await fetch(`https://api.github.com/repos/${repo}/actions/runs?event=workflow_dispatch&status=in_progress,completed&per_page=1`, {
                        headers: { 
                            'Authorization': `token ${token}`, 
                            'User-Agent': 'WireGuard-Generator',
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    const runsData = await runsResponse.json();

                    if (runsData.workflow_runs && runsData.workflow_runs.length > 0) {
                        const latestRun = runsData.workflow_runs[0];
                        if (latestRun.head_branch === 'gh-pages' && latestRun.event === 'workflow_dispatch') {
                            runId = latestRun.id;
                            if (latestRun.status === 'completed' && latestRun.conclusion === 'success') {
                                break;
                            } else if (latestRun.conclusion === 'failure') {
                                throw new Error('Workflow Ø¨Ø§ Ø®Ø·Ø§ ØªÙ…Ø§Ù… Ø´Ø¯. Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.');
                            }
                        }
                    }

                    await new Promise(resolve => setTimeout(resolve, 10000));
                    attempts++;
                }

                if (!runId) {
                    throw new Error('Workflow Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯ ÛŒØ§ timeout. Ø¯Ø³ØªÛŒ Ø§Ø² Actions Ú†Ú© Ú©Ù†ÛŒØ¯.');
                }

                // Fetch step summary for config (GitHub API for run summary)
                const summaryResponse = await fetch(`https://api.github.com/repos/${repo}/actions/runs/${runId}`, {
                    headers: { 
                        'Authorization': `token ${token}`, 
                        'User-Agent': 'WireGuard-Generator'
                    }
                });
                const runData = await summaryResponse.json();
                let config = '';

                // Parse from annotations or fallback to placeholder
                if (runData.annotations_url) {
                    // Fetch annotations (logs/summary)
                    const annotationsResponse = await fetch(runData.annotations_url, {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    const annotations = await annotationsResponse.json();
                    // Extract config from summary (look for ```conf block)
                    config = extractConfigFromAnnotations(annotations);
                }

                if (!config) {
                    config = generatePlaceholderConfig(locationId);  // Fallback
                    console.warn('Using placeholder; real parse failed.');
                }

                // Copy to clipboard
                await navigator.clipboard.writeText(config).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = config;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                });

                document.getElementById('message').textContent = `Ú©Ø§Ù†ÙÛŒÚ¯ ${locationName} Ú©Ù¾ÛŒ Ø´Ø¯! (Ù…Ø¹ØªØ¨Ø± Ø¨Ø±Ø§ÛŒ Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡)`;
                showMessage();

            } catch (error) {
                showError('Ø®Ø·Ø§: ' + error.message + '\nActions Ø±Ø§ Ø¯Ø³ØªÛŒ Ú†Ú© Ú©Ù†ÛŒØ¯: https://github.com/sinavm/wireguard/actions');
            } finally {
                showLoading(false);
            }
        }

        function extractConfigFromAnnotations(annotations) {
            // Simple parse: find ```conf ... ``` block
            for (let ann of annotations) {
                if (ann.message && ann.message.includes('```conf') && ann.message.includes('```')) {
                    const match = ann.message.match(/```conf\s*([\s\S]*?)```/);
                    if (match) return match[1].trim();
                }
            }
            return '';
        }

        function generatePlaceholderConfig(locationId) {
            const configs = {
                'UAE-Dubai': `[Interface]\nPrivateKey = [GENERATED_PRIVATE_KEY]\nAddress = 10.0.0.2/24\nDNS = 8.8.8.8\n\n[Peer]\nPublicKey = [SERVER_PUBLIC_KEY]\nEndpoint = ae-dubai.purevpn.net:1194\nAllowedIPs = 0.0.0.0/0`,
                'UK-London': `[Interface]\nPrivateKey = [GENERATED_PRIVATE_KEY]\nAddress = 10.0.0.2/24\nDNS = 8.8.8.8\n\n[Peer]\nPublicKey = [SERVER_PUBLIC_KEY]\nEndpoint = gb-london.purevpn.net:1194\nAllowedIPs = 0.0.0.0/0`,
                'Germany-Frankfurt': `[Interface]\nPrivateKey = [GENERATED_PRIVATE_KEY]\nAddress = 10.0.0.2/24\nDNS = 8.8.8.8\n\n[Peer]\nPublicKey = [SERVER_PUBLIC_KEY]\nEndpoint = de-frankfurt.purevpn.net:1194\nAllowedIPs = 0.0.0.0/0`,
                'Netherlands-Amsterdam': `[Interface]\nPrivateKey = [GENERATED_PRIVATE_KEY]\nAddress = 10.0.0.2/24\nDNS = 8.8.8.8\n\n[Peer]\nPublicKey = [SERVER_PUBLIC_KEY]\nEndpoint = nl-amsterdam.purevpn.net:1194\nAllowedIPs = 0.0.0.0/0`,
                'Turkey-Istanbul': `[Interface]\nPrivateKey = [GENERATED_PRIVATE_KEY]\nAddress = 10.0.0.2/24\nDNS = 8.8.8.8\n\n[Peer]\nPublicKey = [SERVER_PUBLIC_KEY]\nEndpoint = tr-istanbul.purevpn.net:1194\nAllowedIPs = 0.0.0.0/0`
            };
            return configs[locationId] || '[ERROR: Config not generated]';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showMessage() {
            const msg = document.getElementById('message');
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 5000);
        }

        function showError(msg) {
            const errDiv = document.getElementById('error');
            errDiv.textContent = msg;
            errDiv.style.display = 'block';
            setTimeout(() => { errDiv.style.display = 'none'; }, 10000);
        }
    </script>
</body>
</html>
